# Keycloak Configuration, RBAC (Role-based access control). #

RBAC is a security model that restricts access only to authorized users by roles within the client. In this implementation, WSO2 API Manager is responsible for handling scopes and access to specific claims of each API. The role that Keycloak plays is that of an Identity Provider. It is responsible for creating users, configuring roles, and creating clients for generating JWT Tokens for API consumption.


> All names used in this guide can be adapted for each deploy depending on the environment in which it will be used.

[[_TOC_]]

---
## Supplementary Information:

<details>
<summary> 1. Explanation of how RBAC works</summary>

### How RBAC works

These diagrams simplify the functioning of the access control role.

Example Roles:

|          |          | 
| ---      | ---      | 
| Users    | Roles    |
| user 1   | tsiglas1 | 
| user 2   | tsiglas2 | 

When RBAC is enabled, the configuration of roles in Keycloak will be required (later in the document, it explains how to do it). In this example, the roles "tsiglas 1 and 2" were enabled and assigned to users "user 1 and 2". RBAC is configured for the API "Siglas" so that only users from the role "Tsiglas1" have access.

![Role operation diagram](img/diagrama-RBAC.png)
</details>

<details>
<summary>2. Information to understand the connection between Keycloak - Devportal</summary>

### Application Keys and Secrets for "Devportal"

Every time an application/keys needs to be created to subscribe to an API, a ClientID and secret are generated in Keycloak. This can be seen in the following images, where new applications are created and the necessary keys are generated. Production and Sandbox do not share keys, but generate different ClientIDs.

> "One can create a client with their own ClientID in Keycloak and their own Secrets. These are interchangeable with each other."

> "In the WSO2 Configuration section, there is the application creation section."

![devportal -> apps](img/keycloak-rbac-app.PNG)

![devportal -> apps -> keys](img/keycloak-rbac-app-keys.PNG)

</details>

---

## Keycloak Configuration

### **Role Creation**

You must enter the corresponding realm for the necessary implementation, in this case it will be seen that the realm is called wso2{environment}. This can be applied to any realm.

Within the Roles tab we have the option to create new Roles for the realm. Here we will select Add Role.

![keycloak -> roles](img/keycloak-rbac-roles.PNG)

If we go to the Role configuration Action -> Edit. Here we will be presented with the Users in Role tab where we can see the users belonging to the Role.

To add users to the corresponding Role we must go to:

    Realm "Wso2{environment}"
        Manage
            users / groups

Here we can add users or entire groups directly.

> "entire groups can be added, but this will depend on the configuration of the User Stores that Keycloak has configured. See [Keycloak as Identity Provider.](./keycloak-idm.md)."


![keycloak -> roles -> users in role](img/keycloak-rbac-roles-users.PNG)


### **Creation of new Client Scope**

Within the Client Scope tab, we have the option to create new Client Scopes for the realm. Here we will select Create.

![keycloak -> roles -> Cleint Scope](img/keycloak-rbac-clientscope.PNG)

If we go to the Client Scope configuration Action -> Edit, we will see the Mappers / Scope tab.

Scope: we will see the roles assigned to this Client scope.

Mappers: the mappers are information that will be encrypted within the JWT that we are going to create.

    configure
        Client Scope
            {Client scope name}
                Scope / mappers

In the Mappers tab, we must add the mapper called "Scope" and then edit this mapper.
 

|          |           |
| ---      | ---       |
| ID   | {ClientID}  |
| Name   | Scope  |
| Mapper Type | User Realm Role     |
| Token Claim Name   | scope  |
| Claim JSON Type  | string  |


> The information is autogenerated, but it is recommended to review it before continuing.

Moving on to the Scope tab, we will select the Role created earlier, which contains the authorized users to consume the API.

> We must remove all roles and leave only the authorized one.

![keycloak->roles->CleintScope->scope](img/keycloak-rbac-clientscope-scope.PNG)

### **Client Configuration**

The client to be configured is related to the application created from the DevPortal when we create the keys for Keycloak. This is related to the API when it is subscribed to an application.

> Configuration can be done with a pre-created Keycloak client or with a client created automatically when generating keys for an application within the DevPortal. Depending on the choice of how you want to perform the configuration, instructions on how to create a client in Keycloak are also provided.

<details>
<summary>Creating a Keycloak Client</summary>

### Creating a Keycloak Client

Select the corresponding realm, go to the clients tab and select "Create"

![keycloak->client->addclient](img/keycloak-rbac-client-create.PNG)

</details>

> For more information, see the beginning of the document for complementary information or the document [Keycloak as KeyManager](./keycloak-km.md).

In the same Settings tab, we must look for the Access Type field and select "confidential" as the access type.

![keycloak->client->settings](img/keycloak-rbac-client-settings.PNG)

You should also set the root URL as the WSO2 gateway URL.

Root URL:
```https://apim.{ambiente}.client.com/ ```

> This example URL only applies to the {environment} environment.

In the "scopes" tab, first disable Full scope Allowed and remove all values from Assigned Roles and only add the client scope created in the previous steps.

Then, in the "Client scopes" tab, disable all Assigned Default Client Scopes and set the corresponding Client Scope for this Client ID as "Assigned Optional Client Scope".


---
## WSO2 Configuration

### DevPortal Configuration

#### **Setting up a new application**

As previously explained, applications created through the DevPortal are subscribed to an API and connected to Keycloak.

We access /devportal and create a new application. The shared Quota for Application Tokens can be reconfigured.

> see document  [Managment Token Quotas](./WorkInProgress.md).

![devportal -> apps](img/keycloak-rbac-app.PNG)

![devportal -> apps -> keys](img/keycloak-rbac-app-keys.PNG)

Under the Production/Sanbox keys tab, we find the Consumer Key and Consumer Secret fields. Here we will copy the corresponding Secret and ClientID.

>     Select the Keycloak tab (keycloak-{environment} in this example).

#### **Subscription**

In the Subscription tab, we can subscribe to the corresponding API by clicking the + Subscribe APIS button.


---
### Publisher Configuration

#### **Scope Configuration**

From the /publisher home page, to configure scopes and establish the relationship between WSO2 and Keycloak scopes, we must go to the Scopes tab and create a new scope with the same name as the Role generated in Keycloak.

![publisher-scope](img/keycloak-rbac-publisher-scope.PNG)

#### **Role Configuration**

Under the Resources tab: 
- Overview 
    - API configuration
        - Resources

We can see the different claims with which we can interact. In each of these, we can configure and/or restrict access using the scopes we created.

![publisher-scope-API-resources](img/keycloak-rbac-pusblisher-api-resources.PNG)

![publisher-scope-API-resources-claim](img/keycloak-rbac-pusblisher-api-resources-claim.PNG)
---
> Do not forget that with each change made to the API, a new revision of the API must be deployed.

![config keycloak RBAC](img/keycloak-rbac-pusblisher-api-deploy.PNG)

